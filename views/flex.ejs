<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flex ‚Äî Netflex</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      background: radial-gradient(circle at top, #0d0d0d, #000);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .message {
      background: rgba(25, 25, 25, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .message:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 0 15px rgba(229, 9, 20, 0.4);
    }
    .chat-input {
      position: fixed;
      bottom: 72px;
      left: 0;
      right: 0;
      padding: 12px;
      background: rgba(10, 10, 10, 0.85);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    #message-input {
      background: rgba(255, 255, 255, 0.05);
      border: none;
      outline: none;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      width: 100%;
    }
    #send-btn {
      background: #e50914;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    #send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(229, 9, 20, 0.7);
    }
    .hover-actions button, .hover-actions a {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      transition: all .2s ease;
    }
    .hover-actions button:hover, .hover-actions a:hover {
      background: #e50914;
      color: white;
      transform: scale(1.1);
    }
    .upload-preview {
      position: fixed;
      bottom: 150px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20,20,20,0.9);
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      box-shadow: 0 0 20px rgba(229, 9, 20, 0.4);
    }
  </style>
</head>
<body class="min-h-screen text-white">

  <%- include('partials/navbar') %>

  <main class="max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-extrabold text-red-600 mb-6 tracking-wide">Flex Chat</h1>

    <!-- message list -->
    <div id="chat-box" class="chat-box overflow-y-auto h-[65vh] p-3 space-y-4 rounded-lg bg-gradient-to-b from-black/40 to-black/70">
      <% files.forEach(file => { %>
        <div id="msg-<%= file._id %>" class="msg-wrap <%= (file.uploadedBy._id.toString() === userId) ? 'text-right' : '' %>">
          <div class="inline-block message p-4 rounded-2xl max-w-lg w-fit">
            
            <% if (file.replyTo) { %>
              <div class="text-xs text-gray-300 border-l-2 border-red-600 pl-2 mb-2 italic">
                Replying to: <%= file.replyTo.message ? file.replyTo.message.substring(0,50) : '' %>
              </div>
            <% } %>

            <div class="flex items-center justify-between gap-2 text-gray-300 text-xs mb-1">
              <span class="font-semibold text-white"><%= file.uploadedBy.username %></span>
              <span><%= new Date(file.createdAt).toLocaleString() %></span>
            </div>

            <% if (file.message) { %>
              <p class="mt-1 text-base"><%= file.message %></p>
            <% } %>

            <% if (file.fileUrl) { %>
              <div class="mt-3">
                <% if (file.fileType && file.fileType.startsWith('image/')) { %>
                  <img src="<%= file.fileUrl %>" class="rounded-xl max-w-full shadow-lg" />
                <% } else if (file.fileType && file.fileType.startsWith('video/')) { %>
                  <video src="<%= file.fileUrl %>" controls class="rounded-xl max-w-full"></video>
                <% } else if (file.fileType && file.fileType.startsWith('audio/')) { %>
                  <audio controls class="w-full"><source src="<%= file.fileUrl %>" /></audio>
                <% } else { %>
                  <a href="<%= file.fileUrl %>" download class="underline text-red-500">Download File</a>
                <% } %>
              </div>
            <% } %>

            <% if (file.replies && file.replies.length) { %>
              <div class="mt-3 text-xs text-gray-300 bg-black/30 p-2 rounded">
                <% file.replies.slice(-3).forEach(r => { %>
                  <div>üí¨ <strong><%= r.uploadedBy ? r.uploadedBy.toString() : '' %>:</strong> <%= r.message %></div>
                <% }) %>
              </div>
            <% } %>

            <!-- hover actions -->
            <div class="mt-3 text-xs text-gray-200 hover-actions flex gap-2">
              <button onclick='startReply(<%- JSON.stringify(file._id) %>, <%- JSON.stringify(file.message || "") %>)'>‚Ü©Ô∏è Reply</button>
              
              <% if (String(file.uploadedBy._id) === userId) { %>
                <button onclick="deleteMsg('<%= file._id %>', 'everyone')">üóëÔ∏è Delete</button>
              <% } else { %>
                <button onclick="deleteMsg('<%= file._id %>', 'me')">üö´ Remove</button>
              <% } %>

              <% if (file.fileUrl) { %>
                <a href="<%= file.fileUrl %>" target="_blank">‚¨áÔ∏è View</a>
              <% } %>
            </div>

          </div>
        </div>
      <% }) %>
    </div>

    <!-- reply box -->
    <div id="reply-box" class="max-w-4xl mx-auto hidden"></div>

    <!-- upload preview -->
    <div id="upload-preview" class="upload-preview hidden p-4 w-80 text-center">
      <div id="preview-content"></div>
      <div class="w-full bg-gray-700 h-3 rounded mt-3 overflow-hidden">
        <div id="upload-progress-inner" class="h-3 bg-red-600 w-0"></div>
      </div>
      <div class="mt-2 text-xs text-gray-400">Uploading...</div>
    </div>

    <!-- fixed chat input -->
    <form id="chat-form" class="chat-input max-w-4xl mx-auto flex items-center gap-3">
      <input type="hidden" name="replyTo" id="replyToInput" />
      <input type="file" id="file-input" name="file" class="hidden" />
      <button type="button" id="attach-btn" class="bg-gray-800 p-3 rounded-lg">üìé</button>
      <input name="message" id="message-input" autocomplete="off" placeholder="Message..." class="flex-1" />
      <button id="send-btn" class="px-6 py-2 rounded-lg">Send</button>
    </form>
  </main>

  <%- include('partials/bottomnav') %>

  <script>
    const socket = io();
    const userId = '<%= userId %>';
    socket.emit('join', { userId });

    socket.on('flex:new', () => location.reload());
    socket.on('flex:uploadProgress', (data) => {
      const p = document.getElementById('upload-progress-inner');
      if (p) p.style.width = data.percent + '%';
      if (data.percent >= 100) setTimeout(() => { document.getElementById('upload-preview').classList.add('hidden'); }, 800);
    });
    socket.on('flex:deleted', (d) => document.getElementById('msg-' + d.id)?.remove());

    const fileInput = document.getElementById('file-input');
    const attachBtn = document.getElementById('attach-btn');
    const preview = document.getElementById('upload-preview');
    const previewContent = document.getElementById('preview-content');
    const chatForm = document.getElementById('chat-form');
    const msgInput = document.getElementById('message-input');

    attachBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      if (!fileInput.files.length) return;
      const f = fileInput.files[0];
      let html = '';
      if (f.type.startsWith('image/')) html = `<img src="${URL.createObjectURL(f)}" class="rounded-lg max-h-40 mx-auto" />`;
      else if (f.type.startsWith('video/')) html = `<video src="${URL.createObjectURL(f)}" class="rounded-lg max-h-40 mx-auto" controls></video>`;
      else html = `<div class="text-sm">${f.name}</div>`;
      previewContent.innerHTML = html;
      preview.classList.remove('hidden');
    });

    function startReply(id, text) {
      const box = document.getElementById('reply-box');
      box.innerHTML = `<div class="bg-gray-800 p-2 rounded text-sm">Replying to: ${text} <button onclick="cancelReply()" class="ml-2 text-red-500">‚úñ</button></div>`;
      box.classList.remove('hidden');
      document.getElementById('replyToInput').value = id;
      msgInput.focus();
    }
    function cancelReply() {
      document.getElementById('reply-box').innerHTML = '';
      document.getElementById('reply-box').classList.add('hidden');
      document.getElementById('replyToInput').value = '';
    }

    async function deleteMsg(id, type) {
      const ok = confirm(type === 'everyone' ? 'Delete for everyone?' : 'Delete for you?');
      if (!ok) return;
      const res = await fetch(`/netflex/flex/delete/${id}?type=${type}`, { method: 'DELETE' });
      if (res.ok) document.getElementById('msg-' + id)?.remove();
      else alert('Delete failed');
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData();
      fd.append('message', msgInput.value);
      if (fileInput.files[0]) fd.append('file', fileInput.files[0]);
      if (document.getElementById('replyToInput').value) fd.append('replyTo', document.getElementById('replyToInput').value);
      fd.append('_socketId', socket.id);

      preview.classList.remove('hidden');
      document.getElementById('upload-progress-inner').style.width = '0%';

      const resp = await fetch('/netflex/flex/upload', { method: 'POST', body: fd });
      if (resp.ok) {
        msgInput.value = '';
        fileInput.value = '';
        cancelReply();
        setTimeout(() => location.reload(), 500);
      } else {
        alert('Upload error');
      }
    });
  </script>
</body>
</html>

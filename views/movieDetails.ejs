<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= movie && movie.title ? movie.title : 'Movie' %> - Dreamflex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .nav-link {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.5rem;
      transition: transform 0.3s ease, filter 0.3s ease;
    }
    .nav-icon {
      font-size: 2.5rem;
      color: #888;
      transition: color 0.3s ease, transform 0.3s ease, filter 0.3s ease;
    }
    .nav-link:hover .nav-icon {
      color: #e50914;
      transform: scale(1.2) rotate(-5deg);
      filter: drop-shadow(0 0 10px #e50914);
    }
    @media (max-width: 768px) {
      .nav-icon { font-size: 2rem; }
    }
    /* small visual tweak for truncated text */
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-black text-white min-h-screen">

  <%- include('partials/navbar') %>

  <main class="max-w-7xl mx-auto p-4 space-y-6">

    <!-- Player + basic info card -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Video player (full width on mobile) -->
      <div class="md:col-span-2 w-full rounded-lg overflow-hidden shadow-lg">
       <% 
  let videoSrc = "";
  if (movie) {
    if (movie.type === "movie" && movie.movieUrl) {
      videoSrc = movie.movieUrl.replace('?dl=0','?raw=1').replace('?dl=1','?raw=1');
    } else if (movie.type === "series" && movie.seasonsUrl && movie.seasonsUrl.length > 0) {
      const firstEpisode = movie.seasonsUrl[0].episodes[0];
      if (firstEpisode && firstEpisode.videoUrl) {
        videoSrc = firstEpisode.videoUrl.replace('?dl=0','?raw=1').replace('?dl=1','?raw=1');
      }
    }
  }
%>

<video
  id="episodePlayer"
  controls
  class="w-full h-56 md:h-80 rounded-lg bg-black"
  preload="metadata"
>
  <source src="<%= videoSrc %>" type="video/mp4">
  Your browser does not support video playback.
</video>

      </div>

      <!-- Title, meta, and action buttons -->
      <div class="flex flex-col gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold"><%= movie && movie.title ? movie.title : 'Untitled' %></h1>
          <p class="text-gray-400 text-sm mt-1">
            <% const genres = Array.isArray(movie && movie.genre) ? movie.genre.join(', ') : (movie && movie.genre) || 'N/A'; %>
            • <%= movie && movie.year ? movie.year : '—' %> • <%= movie && movie.country ? movie.country : '—' %> • <%= genres %> • <%= movie && movie.duration ? movie.duration + ' min' : '—' %>
          </p>
          <p class="text-gray-400 text-sm mt-1">
            Director: <%= movie && movie.director ? movie.director : '—' %>
            <% if (movie && Array.isArray(movie.cast) && movie.cast.length) { %>
              • Cast: <%= movie.cast.join(', ') %>
            <% } %>
          </p>
          <p class="text-gray-400 text-sm mt-1">
            Rating: <%= movie && movie.rating ? movie.rating : '—' %>
            <% if (movie && Array.isArray(movie.tags) && movie.tags.length) { %>
              • Tags: <%= movie.tags.join(', ') %>
            <% } %>
          </p>
          <p class="text-gray-400 text-sm mt-1">Audio: <%= movie && Array.isArray(movie.audioLanguages) ? movie.audioLanguages.join(', ') : (movie && movie.audioLanguages) || 'English' %></p>
        </div>

        <!-- Actions -->
        <div class="flex flex-col sm:flex-row sm:flex-wrap gap-3">
          <a href="#" class="flex-1 sm:flex-none sm:w-auto inline-flex items-center justify-center gap-2 bg-red-600 hover:bg-red-500 text-black font-semibold py-2 px-4 rounded-lg">
            <i class="fa-solid fa-play"></i> Watch Now
          </a>

          <form action="/user/netflex/mylist/<%= movie && movie._id ? movie._id : '' %>" method="POST" class="inline">
            <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700">
              <i class="fa-solid fa-plus"></i> Add to List
            </button>
          </form>

          <button id="rateBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700">
            <i class="fa-regular fa-thumbs-up"></i> Rate
          </button>

          <button id="shareBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700">
            <i class="fa-solid fa-share-nodes"></i> Share
          </button>

          <a href="/user/movies/<%= movie && movie._id ? movie._id + '/download' : '#' %>" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700">
            <i class="fa-solid fa-download"></i> Download
          </a>

<% if (user && (user.role === 'admin' || user.userId && movie.uploadedBy && user.userId === movie.uploadedBy.toString())) { %>
  <% if (movie.type === 'series') { %>
    <!-- Delete Current Episode -->
    <form action="/user/netflex/movie/<%= movie._id %>/episode/<%= currentEpisode.episodeNumber %>/delete" method="POST" onsubmit="return confirm('Delete this episode?');">
      <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg mt-2">
        Delete 
      </button>
    </form>
  <% } else { %>
    <!-- Delete entire Movie/Song -->
    <form action="/user/netflex/movie/<%= movie._id %>/delete" method="POST" onsubmit="return confirm('Delete this video?');">
      <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg mt-2">
        Delete 
      </button>
    </form>
  <% } %>
<% } %>

        </div>

        <!-- Compact tags & small meta area for mobile -->
        <div class="mt-2 text-gray-400 text-sm line-clamp-3">
          <%= movie && movie.description ? movie.description : 'No description available.' %>
        </div>
      </div>
    </section>

    <!-- Tabs: Details / Comments / Trailer -->
    <section>
      <div class="border-t border-gray-700 pt-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <ul id="tabs" class="flex gap-4 text-gray-400 text-sm">
            <li><button data-tab="details" class="tab-btn text-white border-b-2 border-transparent py-1 px-2">Details</button></li>
            <li><button data-tab="comments" class="tab-btn py-1 px-2">Comments</button></li>
            <li><button data-tab="trailer" class="tab-btn py-1 px-2">Trailer</button></li>
          </ul>

          <div class="flex items-center gap-2 text-sm text-gray-400">
            <span class="hidden sm:inline">Share:</span>
            <button id="quickShare" class="px-3 py-1 rounded bg-gray-800 hover:bg-gray-700">Copy Link</button>
          </div>
        </div>

        <div id="tabContents" class="mt-4">
          <div id="details" class="tab-content">
            <h3 class="text-lg font-bold mb-2">About</h3>
            <p class="text-gray-300"><%= movie && movie.description ? movie.description : 'No description provided.' %></p>

            <div class="mt-6">
              <h4 class="text-md font-semibold mb-2">More Info</h4>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm text-gray-400">
                <div><span class="font-medium text-gray-200">Duration:</span> <br><%= movie && movie.duration ? movie.duration + ' min' : '—' %></div>
                <div><span class="font-medium text-gray-200">Language(s):</span> <br><%= movie && Array.isArray(movie.audioLanguages) ? movie.audioLanguages.join(', ') : (movie && movie.audioLanguages) || 'English' %></div>
                <div><span class="font-medium text-gray-200">Genre:</span> <br><%= genres %></div>
                <div><span class="font-medium text-gray-200">Country:</span> <br><%= movie && movie.country ? movie.country : '—' %></div>
              </div>
            </div>
          </div>

          <div id="comments" class="tab-content hidden">
            <h3 class="text-lg font-bold mb-2">Comments</h3>
            <div class="text-gray-400 text-sm">Comments area (implement your comments UI here).</div>
          </div>

          <div id="trailer" class="tab-content hidden">
            <h3 class="text-lg font-bold mb-2">Trailer</h3>
            <% if (movie && movie.trailerUrl) { %>
              <div class="rounded-lg overflow-hidden shadow-lg">
                <video controls class="w-full h-56 md:h-72 rounded-lg" preload="metadata">
                  <source src="<%= movie.trailerUrl.replace('?dl=0','?raw=1').replace('?dl=1','?raw=1') %>" type="video/mp4">
                  Your browser does not support video playback.
                </video>
              </div>
            <% } else { %>
              <p class="text-gray-400">No trailer available.</p>
            <% } %>
          </div>
        </div>
      </div>
    </section>

    <% /* Series: Seasons & Episodes */ %>
    <% if (movie && movie.type === 'series' && Array.isArray(movie.seasonsUrl) && movie.seasonsUrl.length > 0) { %>
      <section class="mt-6">
        <h2 class="text-xl font-bold mb-3">Seasons</h2>

        <!-- season buttons -->
        <div class="flex gap-2 overflow-x-auto pb-2">
          <% movie.seasonsUrl.forEach(function(season, sIndex) { %>
            <button
              type="button"
              class="season-btn inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700"
              data-season="<%= sIndex %>"
              id="seasonBtn-<%= sIndex %>"
            >
              Season <%= season.seasonNumber || (sIndex + 1) %>
            </button>
          <% }) %>
        </div>
       <button 
  onclick="document.getElementById('episodeForm').classList.toggle('hidden')" 
  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mt-4"
>
  ➕ Add Episode
</button>

<form id="episodeForm" action="/user/netflex/movieDetails/add-episode/<%= movie._id %>" method="POST" enctype="multipart/form-data" class="hidden mt-4 space-y-3">
  <div>
    <label class="block text-gray-300">Episode Title</label>
    <input type="text" name="title" required class="w-full px-3 py-2 rounded-lg bg-gray-800 text-white">
  </div>
  <div>
    <label class="block text-gray-300">Episode Description</label>
    <textarea name="description" rows="3" class="w-full px-3 py-2 rounded-lg bg-gray-800 text-white"></textarea>
  </div>
  <div class="mb-4">
  <label for="image" class="block text-sm font-medium text-gray-700">Episode Image URL</label>
  <input type="text" name="image" id="image" placeholder="Enter image URL"
    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" />
</div>

  <div>
    <label class="block text-gray-300">Upload Episode</label>
    <input type="file" name="episodeFile" accept="video/*" required class="w-full text-gray-300">
  </div>
  <div>
    <label class="block text-gray-300">Duration (minutes)</label>
    <input type="number" name="duration" class="w-full px-3 py-2 rounded-lg bg-gray-800 text-white">
  </div>
  <button type="submit" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-white">
    Save Episode
  </button>
</form>

        <!-- episodes lists -->
        <div class="mt-4 space-y-4">
          <% movie.seasonsUrl.forEach(function(season, sIndex) { %>
            <div id="season-<%= sIndex %>" class="season-block hidden">
              <h3 class="text-lg font-semibold mb-2">Season <%= season.seasonNumber || (sIndex + 1) %></h3>
              <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <% if (Array.isArray(season.episodes) && season.episodes.length) {
                     season.episodes.forEach(function(ep, eIndex) {
                       // compute directUrl server-side for safety
                       var directUrl = (ep && ep.videoUrl) ? String(ep.videoUrl).replace('?dl=0','?raw=1').replace('?dl=1','?raw=1') : '';
                %>
                  <div
                    class="episode-card cursor-pointer bg-gray-800 rounded-lg shadow-md overflow-hidden p-3 hover:bg-gray-700"
                    data-url="<%= directUrl %>"
                    data-title="<%= (ep && ep.title) ? String(ep.title).replace(/"/g, '&quot;') : ('Episode ' + (ep && ep.episodeNumber ? ep.episodeNumber : (eIndex+1))) %>"
                  >
                    <div class="flex items-start gap-3">
                      <% if (ep && ep.thumbnail) { %>
                        <img src="<%= ep.thumbnail %>" alt="thumb" class="w-20 h-12 object-cover rounded">
                      <% } else { %>
                        <div class="w-20 h-12 bg-gray-700 rounded flex items-center justify-center text-xs text-gray-400">No Image</div>
                      <% } %>
                      <div class="flex-1">
                        <h4 class="text-sm font-semibold"><%= ep && ep.episodeNumber ? 'E' + ep.episodeNumber + ' - ' : '' %><%= ep && ep.title ? ep.title : 'Untitled' %></h4>
                        <p class="text-xs text-gray-400 mt-1"><%= ep && ep.duration ? ep.duration + ' min' : '—' %></p>
                      </div>
                    </div>
                  </div>
                <%   });
                   } else { %>
                  <div class="text-gray-400">No episodes found for this season.</div>
                <% } %>
              </div>
            </div>
          <% }) %>
        </div>
      </section>
    <% } %>
<!-- Admin Controls for Series Completion -->
<% if (
  user &&
  (user.role === 'admin' || (movie.uploadedBy && user.userId === movie.uploadedBy.toString()))
) { %>

  <% if (movie.isSeriesCompleted) { %>
    <p class="text-red-600 font-bold italic">✔ Series Completed</p>
  <% } else { %>

    <% movie.seasonsUrl.forEach(function(season) { %>
      <h3 class="text-lg font-semibold mt-3">Season <%= season.seasonNumber %></h3>

      <% if (season.episodes.length === 0) { %>
        <p class="text-gray-500 italic">No episodes found for this season.</p>
      <% } %>

      <% if (
        user &&
        (user.role === 'admin' || (movie.uploadedBy && user.userId === movie.uploadedBy.toString()))
      ) { %>
        <% if (season.isCompleted) { %>
          <p class="text-gray-500 italic">✔ Season <%= season.seasonNumber %> Completed</p>
        <% } else { %>
          <form action="/user/netflex/movie/<%= movie._id %>/season/<%= season.seasonNumber %>/complete" method="POST">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg mt-2">
              Complete Season
            </button>
          </form>
        <% } %>
      <% } %>
    <% }) %>

  <% } %>   <!-- closes movie.isSeriesCompleted check -->

<% } %>     <!-- closes the OUTER admin check -->


    <form action="/user/netflex/movie/<%= movie._id %>/complete-series" method="POST">
      <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg mt-4">
        Complete Series
      </button>
    </form>
<% } %>
  <% } %>
<% } %>



    </div>
    <!-- Actress Photos -->
    <% if (movie && Array.isArray(movie.actressPhotos) && movie.actressPhotos.length > 0) { %>
      <section class="mt-6">
        <h2 class="text-xl font-bold mb-3">Actress Photos</h2>
        <div class="flex gap-4 overflow-x-auto pb-2">
          <% movie.actressPhotos.forEach(function(photo) { %>
            <img src="<%= photo %>" alt="Actress Photo" class="h-28 w-28 object-cover rounded-lg shadow-md">
          <% }) %>
        </div>
      </section>
    <% } %>

    <!-- Suggested Movies -->
    <% if (Array.isArray(suggestedMovies) && suggestedMovies.length > 0) { %>
      <section class="mt-6">
        <h2 class="text-xl font-bold mb-3">Suggested Movies</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
          <% suggestedMovies.forEach(function(s) { %>
            <div class="bg-gray-800 rounded-lg shadow-md overflow-hidden">
              <a href="/user/netflex/movie/<%= s._id %>" class="block">
                <% if (s.posterUrl) { %>
                  <img src="<%= s.posterUrl %>" alt="<%= s.title %>" class="w-full h-44 object-cover">
                <% } else { %>
                  <div class="w-full h-44 bg-gray-700 flex items-center justify-center text-gray-400">No Poster</div>
                <% } %>
                <div class="p-3">
                  <h3 class="text-sm font-semibold truncate"><%= s.title %></h3>
                  <p class="text-xs text-gray-400 mt-1"><%= Array.isArray(s.genre) ? s.genre.join(', ') : (s.genre || '—') %></p>
                </div>
              </a>
            </div>
          <% }) %>
        </div>
      </section>
    <% } %>

  </main>

  <!-- Scripts: pure client-side JS (no EJS inside) -->
  <script>
    // Tabs logic
    (function(){
      function showTab(name) {
        document.querySelectorAll('.tab-content').forEach(function(el){ el.classList.add('hidden'); });
        var el = document.getElementById(name);
        if (el) el.classList.remove('hidden');

        document.querySelectorAll('.tab-btn').forEach(function(btn){ btn.classList.remove('text-white', 'border-white'); btn.classList.add('text-gray-400'); });
        var active = document.querySelector('.tab-btn[data-tab="' + name + '"]');
        if (active) {
          active.classList.remove('text-gray-400');
          active.classList.add('text-white');
        } else {
          // highlight the clicked button if any
          document.querySelectorAll('.tab-btn').forEach(function(b){
            if (b.getAttribute('data-tab') === name) {
              b.classList.remove('text-gray-400');
              b.classList.add('text-white');
            }
          });
        }
      }

      // wire tab buttons
      document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('.tab-btn').forEach(function(btn){
          btn.addEventListener('click', function(){
            var tab = btn.getAttribute('data-tab');
            if (tab) showTab(tab);
          });
        });

        // default to details
        showTab('details');

        // Season selection logic
        var seasonBtns = document.querySelectorAll('.season-btn');
        if (seasonBtns && seasonBtns.length) {
          seasonBtns.forEach(function(b){
            b.addEventListener('click', function(){
              var idx = b.getAttribute('data-season');
              showSeason(parseInt(idx, 10));
            });
          });
          // show first season by default
          showSeason(0);
        }

        // Episode card click -> change player src
        document.querySelectorAll('.episode-card').forEach(function(card){
          card.addEventListener('click', function(){
            var url = card.getAttribute('data-url');
            if (!url) {
              alert('No video available for this episode.');
              return;
            }
            playEpisodeUrl(url);
          });
        });

        // wire quick share copy
        var quick = document.getElementById('quickShare');
        if (quick) {
          quick.addEventListener('click', function(){
            var link = window.location.href;
            navigator.clipboard && navigator.clipboard.writeText(link).then(function(){
              quick.textContent = 'Copied!';
              setTimeout(function(){ quick.textContent = 'Copy Link'; }, 1500);
            }, function(){
              alert('Copy failed. Use your browser to copy the URL.');
            });
          });
        }
      });

      // Season switcher
      window.showSeason = function(index) {
        var blocks = document.querySelectorAll('.season-block');
        blocks.forEach(function(b){ b.classList.add('hidden'); });
        var block = document.getElementById('season-' + index);
        if (block) block.classList.remove('hidden');

        document.querySelectorAll('.season-btn').forEach(function(btn){ btn.classList.remove('bg-red-600'); btn.classList.add('bg-gray-800'); });
        var activeBtn = document.getElementById('seasonBtn-' + index);
        if (activeBtn) activeBtn.classList.remove('bg-gray-800'), activeBtn.classList.add('bg-red-600');
      };

      // Play a given URL in the main player
      window.playEpisodeUrl = function(url) {
        var player = document.getElementById('episodePlayer');
        if (!player) return;
        var srcTag = player.querySelector('source');
        if (srcTag) {
          srcTag.src = url;
          player.load();
          player.play().catch(function(err){
            // handle autoplay restrictions gracefully
            console.warn('Autoplay/play failed:', err);
          });
        } else {
          player.src = url;
          player.play().catch(function(err){
            console.warn('Autoplay/play failed:', err);
          });
        }
        // scroll into view on mobile so user sees the player
        player.scrollIntoView({ behavior: 'smooth', block: 'center' });
      };
    })();
  </script>

</body>
</html>
